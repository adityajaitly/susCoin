<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <meta name="description" content="Turn gig work into citywide carbon wins. Earn credits for low-carbon work. Unlock citywide rewards. See impact live.">
    
    <!-- Tailwind CSS -->
    <link href="/styles/output.css" rel="stylesheet">
    
    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Confetti library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body class="bg-sus-bg text-sus-text font-sans antialiased">
    <!-- Theme Toggle -->
    <button id="themeToggle" class="fixed top-4 right-4 z-50 p-3 bg-sus-card border border-sus-line rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 text-2xl hover:scale-110 cursor-pointer" title="Toggle dark mode">
        üåô
    </button>

    <!-- Navigation -->
    <nav class="fixed top-0 left-0 right-0 z-40 bg-sus-card/80 backdrop-blur-md border-b border-sus-line">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-sus-primary">üåç susCoin</h1>
                </div>
                <div class="hidden md:flex items-center space-x-8">
                    <a href="#how-it-works" class="text-sus-muted hover:text-sus-text transition-colors">How It Works</a>
                    <a href="#rewards" class="text-sus-muted hover:text-sus-text transition-colors">Rewards</a>
                    <a href="#impact" class="text-sus-muted hover:text-sus-text transition-colors">Impact</a>
                    <a href="#tech" class="text-sus-muted hover:text-sus-text transition-colors">Tech</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="pt-24 pb-16 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto text-center">
            <h1 class="text-4xl md:text-6xl font-bold text-sus-text mb-6 text-balance">
                Turn gig work into 
                <span class="text-sus-primary">citywide carbon wins</span>
            </h1>
            <p class="text-xl md:text-2xl text-sus-muted mb-8 max-w-3xl mx-auto text-balance">
                Earn credits for low-carbon work. Unlock citywide rewards. See impact live.
            </p>
            
            <!-- Primary CTAs -->
            <div class="flex flex-col sm:flex-row gap-4 justify-center mb-12">
                <button class="btn-primary text-lg px-8 py-4" onclick="trackEvent('cta_click', 'join_worker')">
                    üö¥ Join as Worker
                </button>
                <button class="btn-secondary text-lg px-8 py-4" onclick="trackEvent('cta_click', 'cities_partners')">
                    üèôÔ∏è For Cities & Partners
                </button>
                <button class="btn-accent text-lg px-8 py-4" onclick="trackEvent('cta_click', 'view_live_city')">
                    üìä View Live City
                </button>
            </div>

            <!-- Live Counters -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                <div class="card text-center">
                    <div class="text-3xl font-bold text-sus-primary mb-2" id="co2Counter">
                        <%= liveData.co2Saved.toFixed(1) %>
                    </div>
                    <div class="text-sus-muted">CO‚ÇÇe saved today</div>
                </div>
                <div class="card text-center">
                    <div class="text-3xl font-bold text-sus-secondary mb-2" id="workersCounter">
                        <%= liveData.activeWorkers %>
                    </div>
                    <div class="text-sus-muted">Active workers now</div>
                </div>
                <div class="card text-center">
                    <div class="text-3xl font-bold text-sus-accent mb-2" id="rewardsCounter">
                        <%= liveData.rewardsRedeemed %>
                    </div>
                    <div class="text-sus-muted">Rewards redeemed</div>
                </div>
            </div>

            <!-- Demo QR Widget -->
            <div class="card max-w-md mx-auto mb-12">
                <h3 class="text-lg font-semibold mb-4">üéØ Try it now</h3>
                <div class="bg-sus-line rounded-lg p-6 mb-4 text-center">
                    <div class="text-4xl mb-2">üì±</div>
                    <div class="text-sm text-sus-muted">Demo QR Code</div>
                </div>
                <button class="btn-primary w-full" onclick="scanDemoQR()">
                    Scan a demo QR
                </button>
            </div>
        </div>
    </section>

    <!-- Live Impact & Map Section -->
    <section id="impact" class="py-16 px-4 sm:px-6 lg:px-8 bg-sus-card">
        <div class="max-w-7xl mx-auto">
            <h2 class="text-3xl font-bold text-center mb-12">Live Impact & Map</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Map -->
                <div class="lg:col-span-2">
                    <div class="card h-96">
                        <div id="impactMap" class="w-full h-full rounded-lg"></div>
                    </div>
                </div>

                <!-- Filters & Stats -->
                <div class="space-y-6">
                    <!-- Filters -->
                    <div class="card">
                        <h3 class="font-semibold mb-4">Filters</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-sus-muted mb-1">Time</label>
                                <select class="w-full p-2 border border-sus-line rounded-lg bg-sus-card" onchange="updateMap('time', this.value)">
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-sus-muted mb-1">Gig Type</label>
                                <select class="w-full p-2 border border-sus-line rounded-lg bg-sus-card" onchange="updateMap('gigType', this.value)">
                                    <option value="all">All Types</option>
                                    <option value="delivery">Delivery</option>
                                    <option value="rideshare">Rideshare</option>
                                    <option value="services">Services</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-sus-muted mb-1">View</label>
                                <select class="w-full p-2 border border-sus-line rounded-lg bg-sus-card" onchange="updateMap('view', this.value)">
                                    <option value="co2">CO‚ÇÇe Saved</option>
                                    <option value="participation">Participation Rate</option>
                                    <option value="equity">Equity Index</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Callout Cards -->
                    <div class="space-y-4">
                        <div class="card bg-sus-primary text-white">
                            <h4 class="font-semibold mb-2">üèÜ Top Suburb</h4>
                            <p class="text-sm">Downtown West - 847 credits earned</p>
                        </div>
                        <div class="card bg-sus-secondary text-white">
                            <h4 class="font-semibold mb-2">üìà Fastest Rising</h4>
                            <p class="text-sm">Bike Delivery +23% this week</p>
                        </div>
                        <div class="card bg-sus-accent text-sus-text">
                            <h4 class="font-semibold mb-2">‚úÖ Verified Events</h4>
                            <p class="text-sm">98.7% verification rate</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Mini Leaderboard -->
    <section class="py-16 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto">
            <h2 class="text-3xl font-bold text-center mb-8">Leaderboard</h2>
            
            <!-- Tabs -->
            <div class="flex justify-center mb-8">
                <div class="flex bg-sus-line rounded-lg p-1">
                    <button class="px-4 py-2 rounded-md bg-sus-primary text-white font-medium" onclick="switchLeaderboard('city')">
                        üèôÔ∏è City
                    </button>
                    <button class="px-4 py-2 rounded-md text-sus-muted hover:text-sus-text transition-colors" onclick="switchLeaderboard('suburb')">
                        üèòÔ∏è Suburb
                    </button>
                    <button class="px-4 py-2 rounded-md text-sus-muted hover:text-sus-text transition-colors" onclick="switchLeaderboard('gigType')">
                        üö¥ Gig Type
                    </button>
                </div>
            </div>

            <!-- Leaderboard Content -->
            <div id="leaderboardContent" class="card max-w-2xl mx-auto">
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 bg-sus-primary/10 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">ü•á</span>
                            <div>
                                <div class="font-semibold">Downtown West</div>
                                <div class="text-sm text-sus-muted">847 credits</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-sus-primary">+23%</div>
                            <div class="text-sm text-sus-muted">this week</div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-4 bg-sus-secondary/10 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">ü•à</span>
                            <div>
                                <div class="font-semibold">Riverside East</div>
                                <div class="text-sm text-sus-muted">723 credits</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-sus-secondary">+18%</div>
                            <div class="text-sm text-sus-muted">this week</div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-4 bg-sus-accent/10 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">ü•â</span>
                            <div>
                                <div class="font-semibold">University District</div>
                                <div class="text-sm text-sus-muted">689 credits</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-sus-accent">+15%</div>
                            <div class="text-sm text-sus-muted">this week</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- How It Works -->
    <section id="how-it-works" class="py-16 px-4 sm:px-6 lg:px-8 bg-sus-card">
        <div class="max-w-7xl mx-auto">
            <h2 class="text-3xl font-bold text-center mb-12">How It Works</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="text-center">
                    <div class="text-6xl mb-4">üö¥</div>
                    <h3 class="text-xl font-semibold mb-4">1. Do eco-actions</h3>
                    <p class="text-sus-muted">Bike delivery, EV ride, recycling pickup</p>
                </div>
                <div class="text-center">
                    <div class="text-6xl mb-4">üèÜ</div>
                    <h3 class="text-xl font-semibold mb-4">2. Get micro-credits + badges</h3>
                    <p class="text-sus-muted">Earn rewards for every sustainable action</p>
                </div>
                <div class="text-center">
                    <div class="text-6xl mb-4">üéÅ</div>
                    <h3 class="text-xl font-semibold mb-4">3. Unlock rewards & push your city up</h3>
                    <p class="text-sus-muted">Redeem credits and compete on leaderboards</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Rewards Strip -->
    <section id="rewards" class="py-16 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto">
            <h2 class="text-3xl font-bold text-center mb-12">Rewards</h2>
            
            <!-- Partner Rewards Carousel -->
            <div class="flex overflow-x-auto space-x-6 pb-4 scrollbar-hide">
                <div class="card min-w-[300px] text-center">
                    <div class="text-4xl mb-4">üöá</div>
                    <h3 class="font-semibold mb-2">Transit Pass</h3>
                    <p class="text-sus-muted mb-4">Free month of public transport</p>
                    <div class="text-sus-primary font-semibold">500 credits</div>
                </div>
                
                <div class="card min-w-[300px] text-center">
                    <div class="text-4xl mb-4">‚ö°</div>
                    <h3 class="font-semibold mb-2">EV Charging Credit</h3>
                    <p class="text-sus-muted mb-4">$50 off your next charge</p>
                    <div class="text-sus-primary font-semibold">300 credits</div>
                </div>
                
                <div class="card min-w-[300px] text-center">
                    <div class="text-4xl mb-4">‚òï</div>
                    <h3 class="font-semibold mb-2">Caf√© Discount</h3>
                    <p class="text-sus-muted mb-4">20% off at partner caf√©s</p>
                    <div class="text-sus-primary font-semibold">100 credits</div>
                </div>
                
                <div class="card min-w-[300px] text-center">
                    <div class="text-4xl mb-4">üå±</div>
                    <h3 class="font-semibold mb-2">Tree Planting</h3>
                    <p class="text-sus-muted mb-4">Plant a tree in your city</p>
                    <div class="text-sus-primary font-semibold">200 credits</div>
                </div>
            </div>
            
            <!-- Badge Tease -->
            <div class="card max-w-md mx-auto text-center mt-8">
                <div class="text-4xl mb-4">üî•</div>
                <h3 class="font-semibold mb-2">Hit a 7-day streak</h3>
                <p class="text-sus-muted mb-4">Earn bonus credits and exclusive badges</p>
                <button class="btn-accent">Start Streak</button>
            </div>
        </div>
    </section>

    <!-- Diversity & Equity Panel -->
    <section class="py-16 px-4 sm:px-6 lg:px-8 bg-sus-card">
        <div class="max-w-7xl mx-auto">
            <h2 class="text-3xl font-bold text-center mb-12">Diversity & Equity</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Equity Index -->
                <div class="card">
                    <h3 class="font-semibold mb-4">Equity Index</h3>
                    <div class="text-center mb-4">
                        <div class="text-4xl font-bold text-sus-primary mb-2">87.3</div>
                        <div class="text-sus-muted">Current Score</div>
                    </div>
                    <div class="bg-sus-line rounded-full h-3 mb-4">
                        <div class="bg-sus-primary h-3 rounded-full" style="width: 87.3%"></div>
                    </div>
                    <p class="text-sm text-sus-muted">
                        We weight contributions from underserved areas to ensure fair climate benefits.
                    </p>
                </div>
                
                <!-- Breakdowns -->
                <div class="space-y-4">
                    <div class="card">
                        <h4 class="font-semibold mb-2">By Gig Type</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Delivery</span>
                                <span class="text-sus-primary">42%</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Rideshare</span>
                                <span class="text-sus-secondary">38%</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Services</span>
                                <span class="text-sus-accent">20%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h4 class="font-semibold mb-2">Small Businesses</h4>
                        <div class="text-2xl font-bold text-sus-primary mb-2">156</div>
                        <div class="text-sus-muted">Active partners</div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-8 bg-sus-accent/10 border-sus-accent/20">
                <div class="flex items-center space-x-3">
                    <div class="text-2xl">üí°</div>
                    <div>
                        <h4 class="font-semibold">Extra multipliers for contributions from low-income areas</h4>
                        <p class="text-sus-muted">Ensuring climate action benefits everyone</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Impact Calculator -->
    <section class="py-16 px-4 sm:px-6 lg:px-8">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-3xl font-bold text-center mb-12">Impact Calculator</h2>
            
            <div class="card">
                <div class="text-center mb-8">
                    <h3 class="text-xl font-semibold mb-4">If <span id="riderCount">100</span> riders bike 1 delivery/day</h3>
                    <input type="range" min="10" max="1000" value="100" class="w-full" id="riderSlider" oninput="updateCalculator()">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-sus-primary mb-2" id="co2Result">2.4</div>
                        <div class="text-sus-muted">CO‚ÇÇe saved / month (kg)</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-sus-secondary mb-2" id="treesResult">0.12</div>
                        <div class="text-sus-muted">Trees equivalent</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-bold text-sus-accent mb-2" id="congestionResult">15.6</div>
                        <div class="text-sus-muted">Hours congestion avoided</div>
                    </div>
                </div>
                
                <div class="text-center mt-8">
                    <button class="btn-primary" onclick="inviteCrew()">Invite your crew</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Tech & Trust -->
    <section id="tech" class="py-16 px-4 sm:px-6 lg:px-8 bg-sus-card">
        <div class="max-w-7xl mx-auto">
            <h2 class="text-3xl font-bold text-center mb-12">Tech & Trust</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
                <div class="card text-center">
                    <div class="text-4xl mb-4">üîê</div>
                    <h3 class="font-semibold mb-2">Edge QR Attestation</h3>
                    <p class="text-sus-muted">Instant verification at the edge</p>
                </div>
                <div class="card text-center">
                    <div class="text-4xl mb-4">üìù</div>
                    <h3 class="font-semibold mb-2">Append-only Hash Receipts</h3>
                    <p class="text-sus-muted">Immutable proof of actions</p>
                </div>
                <div class="card text-center">
                    <div class="text-4xl mb-4">üõ°Ô∏è</div>
                    <h3 class="font-semibold mb-2">Privacy by Design</h3>
                    <p class="text-sus-muted">Differential privacy, opt-in data</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="card">
                    <h3 class="font-semibold mb-4">For Developers</h3>
                    <div class="space-y-3">
                        <a href="#" class="block text-sus-primary hover:underline">API & SDK Documentation</a>
                        <a href="#" class="block text-sus-primary hover:underline">Sample Webhook</a>
                        <a href="#" class="block text-sus-primary hover:underline">GitHub Repository</a>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="font-semibold mb-4">Privacy & Security</h3>
                    <ul class="space-y-2 text-sm text-sus-muted">
                        <li>‚Ä¢ Differential privacy implementation</li>
                        <li>‚Ä¢ Opt-in data collection only</li>
                        <li>‚Ä¢ No precise location stored</li>
                        <li>‚Ä¢ End-to-end encryption</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <!-- Social Proof -->
    <section class="py-16 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto">
            <h2 class="text-3xl font-bold text-center mb-12">Trusted By</h2>
            
            <!-- Logos -->
            <div class="flex justify-center items-center space-x-8 mb-12 opacity-60">
                <div class="text-2xl font-bold text-sus-muted">City of Portland</div>
                <div class="text-2xl font-bold text-sus-muted">Uber</div>
                <div class="text-2xl font-bold text-sus-muted">DoorDash</div>
                <div class="text-2xl font-bold text-sus-muted">Lyft</div>
            </div>
            
            <!-- Testimonials -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="card">
                    <p class="text-sus-muted mb-4">"susCoin made it easy to track my bike deliveries and earn rewards. The city leaderboard is motivating!"</p>
                    <div class="font-semibold">- Sarah, Bike Courier</div>
                </div>
                <div class="card">
                    <p class="text-sus-muted mb-4">"We've seen a 40% increase in sustainable delivery options since partnering with susCoin."</p>
                    <div class="font-semibold">- Mike, Delivery Partner</div>
                </div>
                <div class="card">
                    <p class="text-sus-muted mb-4">"The equity index ensures our climate initiatives benefit all communities equally."</p>
                    <div class="font-semibold">- Lisa, City Administrator</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Conversion Blocks -->
    <section class="py-16 px-4 sm:px-6 lg:px-8 bg-sus-card">
        <div class="max-w-7xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Worker CTA -->
                <div class="card text-center">
                    <h3 class="text-2xl font-bold mb-4">Earn credits today</h3>
                    <p class="text-sus-muted mb-6">Join thousands of gig workers making climate impact</p>
                    <form class="space-y-4" onsubmit="handleSignup(event, 'worker')">
                        <input type="email" placeholder="Enter your email" required 
                               class="w-full p-3 border border-sus-line rounded-lg bg-sus-card">
                        <button type="submit" class="btn-primary w-full">Get Started</button>
                    </form>
                </div>
                
                <!-- City/Partner CTA -->
                <div class="card text-center">
                    <h3 class="text-2xl font-bold mb-4">Request a pilot</h3>
                    <p class="text-sus-muted mb-6">Bring susCoin to your city or organization</p>
                    <form class="space-y-4" onsubmit="handlePilotRequest(event)">
                        <input type="text" placeholder="Name" required 
                               class="w-full p-3 border border-sus-line rounded-lg bg-sus-card">
                        <input type="email" placeholder="Email" required 
                               class="w-full p-3 border border-sus-line rounded-lg bg-sus-card">
                        <input type="text" placeholder="Organization" required 
                               class="w-full p-3 border border-sus-line rounded-lg bg-sus-card">
                        <textarea placeholder="Message" rows="3" 
                                  class="w-full p-3 border border-sus-line rounded-lg bg-sus-card"></textarea>
                        <button type="submit" class="btn-secondary w-full">Send Request</button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="py-12 px-4 sm:px-6 lg:px-8 bg-sus-text text-white">
        <div class="max-w-7xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="font-bold mb-4">üåç susCoin</h3>
                    <p class="text-gray-300">Turn gig work into citywide carbon wins</p>
                </div>
                <div>
                    <h4 class="font-semibold mb-4">Product</h4>
                    <ul class="space-y-2 text-gray-300">
                        <li><a href="#" class="hover:text-white">How It Works</a></li>
                        <li><a href="#" class="hover:text-white">Rewards</a></li>
                        <li><a href="#" class="hover:text-white">API Docs</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-4">Company</h4>
                    <ul class="space-y-2 text-gray-300">
                        <li><a href="#" class="hover:text-white">About</a></li>
                        <li><a href="#" class="hover:text-white">Press Kit</a></li>
                        <li><a href="#" class="hover:text-white">Contact</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-4">Legal</h4>
                    <ul class="space-y-2 text-gray-300">
                        <li><a href="#" class="hover:text-white">Privacy</a></li>
                        <li><a href="#" class="hover:text-white">Terms</a></li>
                        <li><a href="#" class="hover:text-white">Accessibility</a></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-300">
                <p>&copy; 2024 susCoin. Making climate action rewarding.</p>
            </div>
        </div>
    </footer>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-20 right-4 z-50 hidden">
        <div class="bg-sus-success text-white px-6 py-4 rounded-lg shadow-lg">
            <div id="toastMessage"></div>
        </div>
    </div>

    <script>
        // Initialize Socket.IO
        const socket = io();
        
        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;
        
        // Check for saved theme preference or default to light
        const savedTheme = localStorage.getItem('theme') || 'light';
        
        // Apply theme immediately to prevent flash
        if (savedTheme === 'dark') {
            html.classList.add('dark');
        } else {
            html.classList.remove('dark');
        }
        
        themeToggle.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        
        console.log('Initial theme:', savedTheme);
        console.log('Dark mode active:', html.classList.contains('dark'));
        
        themeToggle.addEventListener('click', () => {
            const isDark = html.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            
            // Add visual feedback
            themeToggle.style.transform = 'scale(1.1)';
            setTimeout(() => {
                themeToggle.style.transform = 'scale(1)';
            }, 150);
            
            console.log('Theme toggled to:', isDark ? 'dark' : 'light');
            console.log('Dark mode active:', html.classList.contains('dark'));
        });
        
        // Real-time data updates
        socket.on('liveData', (data) => {
            document.getElementById('co2Counter').textContent = data.co2Saved.toFixed(1);
            document.getElementById('workersCounter').textContent = data.activeWorkers;
            document.getElementById('rewardsCounter').textContent = data.rewardsRedeemed;
        });
        
        // Demo QR scan
        function scanDemoQR() {
            trackEvent('demo_scan');
            socket.emit('demoScan');
            
            // Show confetti
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
            
            showToast('üéâ You earned 5 credits! Welcome to susCoin!');
        }
        
        // Demo reward received
        socket.on('demoReward', (reward) => {
            showToast(`üéâ ${reward.message}`);
        });
        
        // Leaderboard switching
        function switchLeaderboard(type) {
            trackEvent('leaderboard_filter', { type });
            // Update active tab
            document.querySelectorAll('[onclick^="switchLeaderboard"]').forEach(btn => {
                btn.className = 'px-4 py-2 rounded-md text-sus-muted hover:text-sus-text transition-colors';
            });
            event.target.className = 'px-4 py-2 rounded-md bg-sus-primary text-white font-medium';
            
            // In a real app, you'd fetch and update the leaderboard data here
        }
        
        // Map updates
        function updateMap(type, value) {
            trackEvent('map_filter', { type, value });
            // In a real app, you'd update the map visualization here
        }
        
        // Impact calculator
        function updateCalculator() {
            const riders = parseInt(document.getElementById('riderSlider').value);
            document.getElementById('riderCount').textContent = riders;
            
            const co2PerRider = 0.024; // kg CO2 saved per rider per day
            const treesPerKg = 0.05; // trees equivalent per kg CO2
            const congestionHours = 0.156; // hours avoided per rider per day
            
            document.getElementById('co2Result').textContent = (riders * co2PerRider * 30).toFixed(1);
            document.getElementById('treesResult').textContent = (riders * co2PerRider * 30 * treesPerKg).toFixed(2);
            document.getElementById('congestionResult').textContent = (riders * congestionHours * 30).toFixed(1);
        }
        
        // Invite crew
        function inviteCrew() {
            const riders = document.getElementById('riderCount').textContent;
            const shareText = `Join me on susCoin! If ${riders} of us bike one delivery per day, we could save ${document.getElementById('co2Result').textContent}kg CO2 per month! üåç`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Join susCoin',
                    text: shareText,
                    url: window.location.href
                });
            } else {
                // Fallback to copying to clipboard
                navigator.clipboard.writeText(shareText);
                showToast('üìã Share text copied to clipboard!');
            }
        }
        
        // Form handlers
        function handleSignup(event, type) {
            event.preventDefault();
            const email = event.target.querySelector('input[type="email"]').value;
            
            fetch('/api/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, type })
            })
            .then(response => response.json())
            .then(data => {
                showToast(data.message);
                trackEvent('signup_start', { type });
            });
        }
        
        function handlePilotRequest(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            
            fetch('/api/pilot-request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                showToast(data.message);
                trackEvent('pilot_request_submit');
            });
        }
        
        // Toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }
        
        // Analytics tracking
        function trackEvent(eventName, data = {}) {
            socket.emit('analytics', { event: eventName, data, timestamp: Date.now() });
        }
        
        // Initialize map
        function initMap() {
            const map = L.map('impactMap').setView([45.5152, -122.6784], 11); // Portland coordinates
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add some sample markers
            const sampleData = [
                { lat: 45.5152, lng: -122.6784, title: 'Downtown West', impact: 847 },
                { lat: 45.5231, lng: -122.6765, title: 'Pearl District', impact: 723 },
                { lat: 45.5215, lng: -122.6811, title: 'Old Town', impact: 689 }
            ];
            
            sampleData.forEach(point => {
                const color = point.impact > 800 ? '#065F46' : point.impact > 700 ? '#1D4ED8' : '#A3E635';
                L.circleMarker([point.lat, point.lng], {
                    radius: Math.sqrt(point.impact) / 10,
                    fillColor: color,
                    color: color,
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.7
                }).addTo(map).bindPopup(`${point.title}<br>${point.impact} credits`);
            });
        }
        
        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            updateCalculator();
            
            // Track page view
            trackEvent('page_view', { page: 'home' });
        });
    </script>
</body>
</html>
